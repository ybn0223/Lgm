<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordenen</title>
    <%- include("partials/linksAndScripts") %>
</head>
<body>
    <%- include("partials/navbar") %>
    <main>
        <!-- temporary script -->
        <script>
            if(!localStorage.getItem("321")){ 
                // code executed first time
                $(document).ready(function(){
                    $("#amountMinifigs").modal('show');
                });
                localStorage.setItem("321","true");
            }
        </script>

        <!-- amount of sorted minifigs modal -->
        <div class="modal fade" id="amountMinifigs" tabindex="-1" role="dialog" aria-labelledby="amountMinifigs">
            <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
                <div class="modal-content">
                    <div class="me-2 mt-2 border-bottom-0 text-end">
                        <button type="button" class="btn-close" aria-label="Close" data-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="minifigsAmountForm">
                            <div class="card mx-2 content">
                                <h3 class="text-center">Aantal gewenste minifigs om te ordenen</h3>
                                <div class="card-body text-center">
                                    <input id="minifigsAmount" class="text-center" type="number" aria-label="minifigs amount" required>
                                    <button type="submit" class="btn btn-outline-warning mx-5 mb-2 mt-4">Ga verder</button>
                                </div>
                            </div>
                        </form>         
                    </div>
                </div>
            </div>
        </div>

        <!-- reason blacklist -->
        <div class="modal fade" id="blacklistModal" tabindex="-1" role="dialog" aria-labelledby="blacklistReason">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="me-2 mt-2 border-bottom-0 text-end">
                        <button type="button" class="btn-close" aria-label="Close" data-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="card mx-2 content">
                                <h3 class="text-center">Blacklist</h3>
                                <div class="form-group text-center pb-3 px-2">
                                    <label for="exampleFormControlTextarea1">Reden:</label>
                                    <textarea class="form-control" id="exampleFormControlTextarea1" rows="5"></textarea>
                                    <button type="button" class="btn btn-outline-warning mx-5 mb-2 mt-4" data-dismiss="modal">Opslaan</button>
                                </div>
                            </div>
                        </form>         
                    </div>
                </div>
            </div>
        </div>

        <!-- sort modal -->
        <div class="modal fade" id="sortModal" tabindex="-1" role="dialog" aria-labelledby="ProfileModal" style="display: none;" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                <div class="modal-content">
                    <div class="me-2 mt-2 border-bottom-0 text-end">
                        <button type="button" class="btn-close" aria-label="Close" data-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <h4 class="text-center">Kies een set om de minifig aan toe te voegen</h4>
                            <div class="card mx-2 content">
                                <div class="card-body">
                                    <article class="container d-flex flex-row justify-content-around flex-wrap">
                                        <button class="setCardSortSelect my-4">
                                            <section class="card shadow-sm">
                                                <img width="100%" height="225" src="../assets/exampleA.jpg">
                                                <h3 class="border border-warning m-1">Office</h3>
                                            </section>
                                        </button>
                                        <button class="setCardSortSelect">
                                            <section class="card shadow-sm">
                                                <img width="100%" height="225" src="../assets/exampleB.jpg">
                                                <h3 class="border border-warning">Disney</h3>
                                            </section>
                                        </button>
                                        <button class="setCardSortSelect">
                                            <section class="card shadow-sm">
                                                <img width="100%" height="225" src="../assets/exampleD.jpg">
                                                <h3 class="border border-warning">Car Caravan</h3>
                                            </section>
                                        </button>
                                        <button class="setCardSortSelect">
                                            <section class="card shadow-sm">
                                                <img width="100%" height="225" src="../assets/exampleC.jpg">
                                                <h3 class="border border-warning mb-0">Harry Potter</h3>
                                            </section>
                                        </button>
                                    </article>
                                </div>
                            </div>
                        </form>         
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-2 mb-5">
            <div class="row">
                <div class="col-12">
                    <h3 id="sortFigTitle" class="text-center">Aladdin</h3>
                    <div class="placeholder-giant-box d-flex justify-content-center align-items-center">
                        <img id="minifigImage" src="/assets/Alladin.png" alt="Character Image" class="inside-image" />
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-center">
            <button id="skipButton" class="btn btn-warning mx-2">Skip</button>
            <button id="sortButton" class="btn btn-warning mx-2" data-toggle="modal" data-target="#sortModal">Orden</button>
            <button class="btn btn-warning mx-2" data-toggle="modal" data-target="#blacklistModal">Blacklist</button>
        </div>
    </main>
    <footer class="py-3 mt-5">
        <%- include("partials/footer") %>
    </footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let minifigsQueue = [];
            let currentMinifigIndex = 0;
            let userId = '<%= user._id %>';  // Ensure user._id is available

            const fetchMinifigs = async (amount) => {
                try {
                    const response = await fetch(`/minifigs/fetch?amount=${amount}`);
                    const minifigs = await response.json();
                    return minifigs;
                } catch (error) {
                    console.error('Error fetching minifigs:', error);
                    return [];
                }
            };

            const showNextMinifig = () => {
                if (currentMinifigIndex < minifigsQueue.length) {
                    const minifig = minifigsQueue[currentMinifigIndex];
                    $('#sortFigTitle').text(minifig.name);
                    $('#minifigImage').attr('src', minifig.imageURL); // Assuming minifig has imageURL field
                    $('#sortModal').modal('hide');
                } else {
                    alert('All minifigs sorted');
                    $('#sortModal').modal('hide');
                }
            };

            const handleSetSelection = async (setName) => {
                const minifig = minifigsQueue[currentMinifigIndex];
                const isCorrect = minifig.sets.includes(setName); // Assuming minifig has sets field

                try {
                    await fetch('/minifigs/updateCollection', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ userId, minifigId: minifig._id, setName, isCorrect }),
                    });
                    if (!isCorrect) {
                        minifigsQueue.push(minifigsQueue.splice(currentMinifigIndex, 1)[0]);
                    }
                    currentMinifigIndex++;
                    showNextMinifig();
                } catch (error) {
                    console.error('Error updating collection:', error);
                }
            };

            $('#minifigsAmountForm').on('submit', async (event) => {
                event.preventDefault();
                const amount = $('#minifigsAmount').val();
                minifigsQueue = await fetchMinifigs(amount);
                currentMinifigIndex = 0;
                showNextMinifig();
            });

            $('.setCardSortSelect').on('click', function() {
                const setName = $(this).find('h3').text();
                handleSetSelection(setName);
            });

            $('#skipButton').on('click', () => {
                minifigsQueue.push(minifigsQueue.splice(currentMinifigIndex, 1)[0]);
                currentMinifigIndex++;
                showNextMinifig();
            });

            $('#sortButton').on('click', () => {
                $('#sortModal').modal('show');
            });
        });
    </script>
</body>
</html>